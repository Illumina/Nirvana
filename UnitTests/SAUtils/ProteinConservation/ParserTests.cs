using System.IO;
using System.Linq;
using SAUtils.AAConservation;
using Xunit;

namespace UnitTests.SAUtils.ProteinConservation
{
    public sealed class ParserTests
    {
        private static Stream GetStream()
        {
            var stream = new MemoryStream();
            var writer = new StreamWriter(stream);

            writer.WriteLine("#Ensembl\tChromosome\tProteinSequence\tPercent Conservation at each AA residue");
            writer.WriteLine("ENST00000641515\tchr1\tMKKVTAEAISWNESTSETNNSMVTEFIFLGLSDSQELQTFLFMLFFVFYGGIVFGNLLIVITVVSDSHLHSPMYFLLANLSLIDLSLSSVTAPKMITDFFSQRKVISFKGCLVQIFLLHFFGGSEMVILIAMGFDRYIAICKPLHYTTIMCGNACVGIMAVTWGIGFLHSVSQLAFAVHLLFCGPNEVDSFYCDLPRVIKLACTDTYRLDIMVIANSGVLTVCSFVLLIISYTIILMTIQHRPLDKSSKALSTLTAHITVVLLFFGPCVFIYAWPFPIKSLDKFLAVFYSVITPLLNPIIYTLRNKDMKTAIRQLRKWDAHSSVKFZ\t40,38,11,34,37,11,31,17,25,31,38,39,37,38,12,35,33,33,52,9,47,20,66,56,61,73,50,40,57,71,62,55,28,47,34,55,51,61,6,44,58,61,5,29,66,38,42,43,71,10,41,55,46,35,65,79,54,49,56,44,32,47,54,17,34,63,40,49,79,67,54,81,78,77,63,52,74,46,65,72,61,37,40,71,55,23,41,50,57,55,57,44,79,65,53,40,18,60,45,43,46,16,27,60,40,73,70,57,35,61,81,46,15,80,41,62,37,43,60,45,50,58,51,44,69,20,42,41,79,37,48,78,9,49,81,81,75,17,77,72,76,46,80,79,37,80,44,49,64,70,24,30,29,8,66,31,41,30,8,40,15,5,73,38,23,63,54,50,57,56,41,41,57,39,41,49,40,39,9,73,1,67,75,62,58,63,36,40,53,44,54,48,76,71,42,58,44,56,47,52,74,60,77,43,62,57,48,36,43,37,49,41,47,41,48,51,56,60,44,44,39,45,36,37,58,33,43,55,44,50,70,73,43,31,66,61,20,45,48,36,18,27,43,5,25,10,42,41,81,72,52,61,79,43,39,44,76,49,52,67,66,42,63,64,57,52,55,48,11,56,49,67,43,40,63,50,43,35,35,47,45,58,58,49,41,49,58,47,53,39,56,22,55,72,46,62,80,76,43,78,80,56,70,61,65,61,43,52,64,30,57,19,39,4,50,35,31,28,10,8,8,30,8,19,33,7,39");
            writer.WriteLine("ENST00000335137\tchr1\tMVTEFIFLGLSDSQELQTFLFMLFFVFYGGIVFGNLLIVITVVSDSHLHSPMYFLLANLSLIDLSLSSVTAPKMITDFFSQRKVISFKGCLVQIFLLHFFGGSEMVILIAMGFDRYIAICKPLHYTTIMCGNACVGIMAVTWGIGFLHSVSQLAFAVHLLFCGPNEVDSFYCDLPRVIKLACTDTYRLDIMVIANSGVLTVCSFVLLIISYTIILMTIQHRPLDKSSKALSTLTAHITVVLLFFGPCVFIYAWPFPIKSLDKFLAVFYSVITPLLNPIIYTLRNKDMKTAIRQLRKWDAHSSVKFZ\t20,66,56,61,73,50,40,57,71,62,55,28,47,34,55,51,61,6,44,58,61,5,29,66,38,42,43,71,10,41,55,46,35,65,79,54,49,56,44,32,47,54,17,34,63,40,49,79,67,54,81,78,77,63,52,74,46,65,72,61,37,40,71,55,23,41,50,57,55,57,44,79,65,53,40,18,60,45,43,46,16,27,60,40,73,70,57,35,61,81,46,15,80,41,62,37,43,60,45,50,58,51,44,69,20,42,41,79,37,48,78,9,49,81,81,75,17,77,72,76,46,80,79,37,80,44,49,64,70,24,30,29,8,66,31,41,30,8,40,15,5,73,38,23,63,54,50,57,56,41,41,57,39,41,49,40,39,9,73,1,67,75,62,58,63,36,40,53,44,54,48,76,71,42,58,44,56,47,52,74,60,77,43,62,57,48,36,43,37,49,41,47,41,48,51,56,60,44,44,39,45,36,37,58,33,43,55,44,50,70,73,43,31,66,61,20,45,48,36,18,27,43,5,25,10,42,41,81,72,52,61,79,43,39,44,76,49,52,67,66,42,63,64,57,52,55,48,11,56,49,67,43,40,63,50,43,35,35,47,45,58,58,49,41,49,58,47,53,39,56,22,55,72,46,62,80,76,43,78,80,56,70,61,65,61,43,52,64,30,57,19,39,4,50,35,31,28,10,8,8,30,8,19,33,7,39");
            writer.WriteLine("ENST00000379407\tchr1\tMGNSHCVPQAPRRLRASFSRKPSLKGNREDSARMSAGLPGPEAARSGDAAANKLFHYIPGTDILDLENQRENLEQPFLSVFKKGRRRVPVRNLGKVVHYAKVQLRFQHSQDVSDCYLELFPAHLYFQAHGSEGLTFQGLLPLTELSVCPLEGSREHAFQITGPLPAPLLVLCPSRAELDRWLYHLEKQTALLGGPRRCHSAPPQGSCGDELPWTLQRRLTRLRTASGHEPGGSAVCASRVKLQHLPAQEQWDRLLVLYPTSLAIFSEELDGLCFKGELPLRAVHINLEEKEKQIRSFLIEGPLINTIRVVCASYEDYGHWLLCLRAVTHREGAPPLPGAESFPGSQVMGSGRGSLSSGGQTSWDSGCLAPPSTRTSHSLPESSVPSTVGCSSQHTPLHRLSLESSPDAPDHTSETSHSPLYADPYTPPATSHRRVTDVRGLEEFLSAMQSARGPTPSSPLPSVPVSVPASDPRSCSSGPAGPYLLSKKGALQSRAAQRHRGSAKDGGPQPPDAPQLVSSAREGSPEPWLPLTDGRSPRRSRDPGYDHLWDETLSSSHQKCPQLGGPEASGGLVQWIZ\t67,70,66,54,41,68,60,69,67,60,66,55,63,54,71,61,68,66,59,68,67,63,66,67,68,51,40,56,55,53,20,35,57,9,3,50,52,55,1,64,12,52,47,12,7,11,47,58,28,39,53,15,50,15,49,25,56,53,61,56,45,48,60,15,13,50,60,31,65,31,72,52,67,49,73,61,67,60,71,59,72,71,62,68,65,71,49,42,51,80,73,60,73,79,66,58,48,60,74,48,76,78,53,60,59,75,72,77,60,76,56,46,57,69,74,64,76,73,75,73,53,15,57,80,69,72,72,60,54,70,58,40,77,73,73,53,75,67,61,59,61,66,25,56,63,52,42,52,46,41,54,53,48,46,59,55,57,59,57,59,61,56,70,68,58,51,70,69,54,68,52,69,57,51,11,53,68,62,14,40,70,73,65,66,70,68,71,69,11,57,72,16,61,68,9,22,40,52,48,39,38,46,48,71,51,12,7,27,47,46,50,52,48,39,44,41,30,33,44,40,36,53,41,33,36,47,50,22,28,12,12,53,38,47,12,61,54,58,55,59,55,61,52,52,53,52,9,52,59,53,42,54,59,52,64,56,61,57,60,39,52,59,52,59,52,59,57,55,8,46,56,59,42,57,57,66,64,66,62,62,13,60,18,47,49,54,54,54,57,39,47,57,53,55,54,58,63,63,62,65,64,18,65,68,66,54,69,70,69,41,70,57,65,66,62,68,66,13,43,70,65,54,70,67,33,17,38,12,18,51,13,45,29,29,27,52,41,54,11,50,44,45,43,65,15,29,41,8,54,33,54,52,63,60,58,50,60,10,61,13,54,55,56,40,51,53,47,17,45,41,36,47,42,25,55,64,40,56,57,61,51,44,42,39,45,37,44,14,47,45,9,13,36,8,11,46,35,9,38,30,39,55,45,13,26,40,9,46,51,41,35,6,12,48,36,11,53,61,64,59,57,60,58,60,57,59,59,64,56,54,57,49,25,15,15,52,57,51,33,47,60,14,56,56,57,46,52,44,47,46,5,3,55,59,2,48,37,60,44,11,51,34,48,55,52,59,54,68,12,51,46,45,3,23,2,19,13,42,27,5,35,46,5,49,47,43,41,57,46,39,36,49,31,56,51,6,50,53,51,52,51,60,16,54,10,8,44,43,23,54,43,46,3,53,53,44,53,50,19,31,44,50,31,43,55,13,49,3,28,52,15,13,44,44,15,22,43,28,17,9,4,6,18,13,33,20,10,12,47,42,16,24,21,45,17,56,36,39,34,11,50,19,23,38,18,47,49,44,10,36,52,49,18,58,59,59,58");
            writer.WriteLine("ENST00000379319\tchr1\tMALRHLALLAGLLVGVASKSMENTAQLPECCVDVVGVNASCPGASLCGPGCYRRWNADGSASCVRCGNGTLPAYNGSECRSFAGPGAPFPMNRSSGTPGRPHPGAPRVAASLFLGTFFISSGLILSVAGFFYLKRSSKLPRACYRRNKAPALQPGEAAAMIPPPQSSVRKPRYVRRERPLDRATDPAAFPGEARISNVZ\t57,48,53,12,18,25,12,54,62,51,49,52,51,45,23,51,44,56,41,52,8,44,9,4,26,52,10,55,53,61,61,46,52,47,33,11,26,59,39,19,64,55,53,10,33,54,64,53,62,60,62,59,53,24,38,39,24,55,63,52,21,57,61,38,40,61,13,60,45,59,17,29,22,21,40,32,59,52,65,55,31,11,34,49,2,49,33,18,41,52,31,54,51,55,18,55,36,55,56,30,49,25,17,49,14,73,19,75,68,77,77,76,56,78,78,78,46,50,66,78,44,55,80,80,79,68,77,77,37,76,78,78,78,76,78,47,57,63,80,76,23,3,13,75,57,71,55,64,52,50,42,54,54,54,46,56,47,57,49,58,52,59,45,63,47,48,58,52,65,64,67,66,58,52,65,64,58,60,50,34,46,39,20,18,23,44,26,45,25,12,3,47,50,59,21,64,52,64,59");
            
            writer.Flush();

            stream.Position = 0;
            return stream;
        }

        [Fact]
        public void ReadItemsTest()
        {
            using (var stream = GetStream())
            using (var parser = new ProteinConservationParser(stream))
            {
                var items = parser.GetItems().ToArray();
                
                Assert.Equal(4, items.Length);
                
                Assert.Equal("ENST00000641515", items[0].TranscriptId);
                Assert.Equal(new byte[]{40,38,11,34,37,11,31,17,25,31,38,39,37,38,12,35,33,33,52,9,47,20,66,56,61,73,50,40,57,71,62,55,28,47,34,55,51,61,6,44,58,61,5,29,66,38,42,43,71,10,41,55,46,35,65,79,54,49,56,44,32,47,54,17,34,63,40,49,79,67,54,81,78,77,63,52,74,46,65,72,61,37,40,71,55,23,41,50,57,55,57,44,79,65,53,40,18,60,45,43,46,16,27,60,40,73,70,57,35,61,81,46,15,80,41,62,37,43,60,45,50,58,51,44,69,20,42,41,79,37,48,78,9,49,81,81,75,17,77,72,76,46,80,79,37,80,44,49,64,70,24,30,29,8,66,31,41,30,8,40,15,5,73,38,23,63,54,50,57,56,41,41,57,39,41,49,40,39,9,73,1,67,75,62,58,63,36,40,53,44,54,48,76,71,42,58,44,56,47,52,74,60,77,43,62,57,48,36,43,37,49,41,47,41,48,51,56,60,44,44,39,45,36,37,58,33,43,55,44,50,70,73,43,31,66,61,20,45,48,36,18,27,43,5,25,10,42,41,81,72,52,61,79,43,39,44,76,49,52,67,66,42,63,64,57,52,55,48,11,56,49,67,43,40,63,50,43,35,35,47,45,58,58,49,41,49,58,47,53,39,56,22,55,72,46,62,80,76,43,78,80,56,70,61,65,61,43,52,64,30,57,19,39,4,50,35,31,28,10,8,8,30,8,19,33,7,39} , items[0].Scores);
                
                Assert.Equal("ENST00000379319", items[3].TranscriptId);
            }
        }
    }
}