using Cloud;
using Xunit;

namespace UnitTests.Cloud
{
    public sealed class RedactionUtilitiesTests
    {
        [Fact]
        public void Redact_PresignedUrl()
        {
            const string json     = "{\"id\":\"e96a15ab-13f8-48cd-b3b8-ca37aca8480f\",\"genomeAssembly\":\"GRCh37\",\"vcfUrl\":\"https://s3.amazonaws.com/illumina-early-access/Test.vcf.gz?AWSAccessKeyId=AKISKSD87A3C4&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\",\"tabixUrl\":\"https://s3.amazonaws.com/illumina-early-access/Test.vcf.gz.tbi?AWSAccessKeyId=AKISKSD87A3C4&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\",\"outputDir\":{\"bucketName\":\"illumina-early-access\",\"region\":\"us-east-1\",\"path\":\"/5a2a3c8c-3744-422d-b343/\",\"accessKey\":\"AKIAIOSFODNN7EXAMPLE\",\"secretKey\":\"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY\",\"sessionToken\":\"AQoEXAMPLEH4aoAH0gNCAPyJxz4BlCFFxWNE1OPTgk5TthT+FvwqnKwRcOIfrRh3c/LTo6UDdyJwOOvEVPvLXCrrrUtdnniCEXAMPLE/IvU1dYUg2RVAJBanLiHb4IgRmpRV3zrkuWJOgQs8IZZaIv2BXIa2R4OlgkBN9bkUDNCJiBeb/AXlzBBko7b15fjrBs2+cTQtpZ3CYWFXG8C5zqx37wnOE49mRl/+OtkIKGO7fAE\"},\"supplementaryAnnotations\":\"latest\",\"customAnnotations\":[{\"nsaUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nsa?AWSAccessKeyId=AKISKSD87A3C4&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\",\"idxUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nsa.idx?AWSAccessKeyId=AKISKSD87A3C4&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\"},{\"nsiUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nsi?AWSAccessKeyId=AKISKSD87A3C4&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\"},{\"ngaUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nga?AWSAccessKeyId=AKISKSD87A3C4&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\"}]}";
            const string expected = "{\"id\":\"e96a15ab-13f8-48cd-b3b8-ca37aca8480f\",\"genomeAssembly\":\"GRCh37\",\"vcfUrl\":\"https://s3.amazonaws.com/illumina-early-access/Test.vcf.gz?AWSAccessKeyId=XXXXXXXXXXXXX&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\",\"tabixUrl\":\"https://s3.amazonaws.com/illumina-early-access/Test.vcf.gz.tbi?AWSAccessKeyId=XXXXXXXXXXXXX&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\",\"outputDir\":{\"bucketName\":\"illumina-early-access\",\"region\":\"us-east-1\",\"path\":\"/5a2a3c8c-3744-422d-b343/\",\"accessKey\":\"XXXXXXXXXXXXXXXXXXXX\",\"secretKey\":\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\",\"sessionToken\":\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\"},\"supplementaryAnnotations\":\"latest\",\"customAnnotations\":[{\"nsaUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nsa?AWSAccessKeyId=XXXXXXXXXXXXX&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\",\"idxUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nsa.idx?AWSAccessKeyId=XXXXXXXXXXXXX&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\"},{\"nsiUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nsi?AWSAccessKeyId=XXXXXXXXXXXXX&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\"},{\"ngaUrl\":\"https://s3.amazonaws.com/illumina-early-access/ClinVar.nga?AWSAccessKeyId=XXXXXXXXXXXXX&Expires=109838429&Signature=s98df7s8df12f2jo4lfjfs9d0fu0sd9f\"}]}";

            string observed = json.Redact();
            Assert.Equal(expected, observed);
        }

        [Fact]
        public void Redact_AwsSignatureVersion4()
        {
            const string json     = "{\"id\":\"Test\",\"genomeAssembly\":\"GRCh38\",\"vcfUrl\":\"https://illumina-dev.s3.us-west-2.amazonaws.com/Annotation/input/test.vcf.gz?X-Amz-Expires=604800&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAZYATIEHL37L46ZIO/20191007/us-west-2/s3/aws4_request&X-Amz-Date=20191007T222533Z&X-Amz-SignedHeaders=host&X-Amz-Signature=44433f0ec4875323d8e82084469f4e34b6384aead83f9c176595b96badaba3f8\",\"tabixUrl\":\"https://illumina-dev.s3.us-west-2.amazonaws.com/Annotation/input/test.vcf.gz.tbi?X-Amz-Expires=604800&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAZYATIEHL37L46ZIO/20191007/us-west-2/s3/aws4_request&X-Amz-Date=20191007T222533Z&X-Amz-SignedHeaders=host&X-Amz-Signature=19cd9c1244cf156952746e85bfc4977946a80a1110205a3dae9b578647dacd50\",\"outputDir\":{\"bucketName\":\"illumina-early-access\",\"region\":\"us-east-1\",\"path\":\"/5a2a3c8c-3744-422d-b343/\",\"accessKey\":\"AKIAIOSFODNN7EXAMPLE\",\"secretKey\":\"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY\",\"sessionToken\":\"AQoEXAMPLEH4aoAH0gNCAPyJxz4BlCFFxWNE1OPTgk5TthT+FvwqnKwRcOIfrRh3c/LTo6UDdyJwOOvEVPvLXCrrrUtdnniCEXAMPLE/IvU1dYUg2RVAJBanLiHb4IgRmpRV3zrkuWJOgQs8IZZaIv2BXIa2R4OlgkBN9bkUDNCJiBeb/AXlzBBko7b15fjrBs2+cTQtpZ3CYWFXG8C5zqx37wnOE49mRl/+OtkIKGO7fAE\"},\"supplementaryAnnotations\":\"latest\",\"customAnnotations\":null}";
            const string expected = "{\"id\":\"Test\",\"genomeAssembly\":\"GRCh38\",\"vcfUrl\":\"https://illumina-dev.s3.us-west-2.amazonaws.com/Annotation/input/test.vcf.gz?X-Amz-Expires=604800&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=XXXXXXXXXXXXXXXXXXXX/20191007/us-west-2/s3/aws4_request&X-Amz-Date=20191007T222533Z&X-Amz-SignedHeaders=host&X-Amz-Signature=44433f0ec4875323d8e82084469f4e34b6384aead83f9c176595b96badaba3f8\",\"tabixUrl\":\"https://illumina-dev.s3.us-west-2.amazonaws.com/Annotation/input/test.vcf.gz.tbi?X-Amz-Expires=604800&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=XXXXXXXXXXXXXXXXXXXX/20191007/us-west-2/s3/aws4_request&X-Amz-Date=20191007T222533Z&X-Amz-SignedHeaders=host&X-Amz-Signature=19cd9c1244cf156952746e85bfc4977946a80a1110205a3dae9b578647dacd50\",\"outputDir\":{\"bucketName\":\"illumina-early-access\",\"region\":\"us-east-1\",\"path\":\"/5a2a3c8c-3744-422d-b343/\",\"accessKey\":\"XXXXXXXXXXXXXXXXXXXX\",\"secretKey\":\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\",\"sessionToken\":\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\"},\"supplementaryAnnotations\":\"latest\",\"customAnnotations\":null}";

            string observed = json.Redact();
            Assert.Equal(expected, observed);
        }
    }
}
